{% extends 'frontend/base.html' %}
{% load static i18n %}

{% block extrahead %}
    <script src="//cdn.amcharts.com/lib/4/core.js"></script>
    <script src="//cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="//cdn.amcharts.com/lib/4/themes/animated.js"></script>
    <script src="{% static 'external/jquery.highlight.js' %}"></script>
    <script type="text/javascript">
    var MEDIA_URL = '{% get_media_prefix %}';
    var treemap;
    var series_templates = [];
    var last_budget_id = {{ last_budget.id }};
    var current_budget_id = last_budget_id;
    var current_budget_account = '{{ default_budget_account }}';
    var current_budget_account_id = null;
    var current_group = '{{ default_group }}';
    var current_budget_data = null;
    var current_datatable_order = {field: 'budget_aggregated', order_dir: 'desc'};
    var budgets = {{ budgets_serialized|safe }};
    var skip_cache = {% if request.GET.no_cache %}true{% else %}false{% endif %};
    var breadcrumb = [
        {'name': "Por Função", 'id': null},
        {'name': {{ last_budget.year }}, 'id': null},
    ];
    var budget_account_label_map = {
        'expenses': "{% trans 'Expenses' %}",
        'revenues': "{% trans 'Revenues' %}",
    }
    var group_label_map = {
        'organic': "{% trans 'Agency' %}",
        'functional': "{% trans 'Function' %}",
        'nature': "{% trans 'Nature' %}",
        'source': "{% trans 'Source' %}",
    }
    var sub_group_label_map = {
        'organic': "{% trans 'Budget Unit' %}",
        'functional': "{% trans 'Sub-function' %}",
        'nature': "{% trans 'Especification' %}",
        'source': "{% trans 'Detailed source' %}",
    }
    am4core.useTheme(am4themes_animated);

    function loading(show=true, wrapper_selector=null){
        var $loading_wrap = $('.loading');
        if(wrapper_selector){
            $loading_wrap = $(wrapper_selector).find('.loading');
        }
        if(show){
            $loading_wrap.fadeIn();
        } else {
            $loading_wrap.fadeOut();
        }
    }

    function get_group_label(level, group){
        var label_map = group_label_map
        if(level == 1){
            label_map = sub_group_label_map;
        }
        return label_map[group];
    }
    function get_budget_basic_info(budget_id, callback){
        var url = '/api/budgets/' + budget_id + '/';
        $.get(url, function (data) {
            callback(data);
        }).fail(function () {
            console.log("Error on fetching budget basic info.");
        });
    }
    function get_budget_data(budget_id, budget_account, group, callback){
        var url = MEDIA_URL + 'budgets/{{ country.slug }}_' + budget_account + '_' + group + '_' + get_budget_year_by_id(budget_id) + '.json'
        if(skip_cache){
            // If skip_cache, retrieve data from api.
            url = '/api/budgets/' + budget_id + '/' + budget_account + '/?group=' + group;
        }

        $.get(url, function (data) {
            callback(data);
        }).fail(function () {
            console.log("Error on fetching budget data.");
        });
    }
    function get_historical_data(budget_id, budget_account, budget_account_id, group, callback){
        var params = {
            group: group,
            budget_account: budget_account,
            budget_account_id: budget_account_id
        }
        var url = '/api/budgets/' + budget_id + '/historical/';
        $.get(url, params, function (data) {
            callback(data);
        }).fail(function () {
            console.log("Error on fetching historical data.");
        });
    }
    function get_budget_account_aggregated_data(budget_data){
        /*
        Get data for the whole budget, with sum of all level 0 categories.
         */
        // Initialize aggregated data by copying structure of first element.
        var aggregated_data = $.extend(true, {}, budget_data[0]);
        var fields = ['budget_aggregated', 'budget_investment', 'budget_operation', 'execution_aggregated',
            'execution_investment', 'execution_operation', 'initial_budget_aggregated', 'initial_budget_investment',
            'initial_budget_operation'];
        // Set null for values fiels on initialize.
        fields.forEach(function(item, index){
            aggregated_data[item] = null;
        });
        aggregated_data['label'] = "{% trans 'Budget' %} " + get_budget_year_by_id(current_budget_id);
        aggregated_data['name'] = "{{ country.name }}";
        aggregated_data['id'] = null;
        for(var i = 0; i < budget_data.length; i++){
            fields.forEach(function(item, index){
                if(item == 'budget_aggregated' && !budget_data[i]['has_budget']){
                    // If category has execution_aggregated but not budget_aggregated, budget_aggregated comes with
                    // same amount as the execution_aggregated to fill treemap nicely. Here we prevent the sum of these
                    // categories to the whole amount of the budget.
                    return;
                }
                var new_value = budget_data[i][item];
                if(!new_value){
                    return;
                }
                if(!aggregated_data[item]){
                    aggregated_data[item] = 0
                }
                aggregated_data[item] += new_value;
                if(item == 'budget_aggregated'){
                    // Here we force has_budget to true, in case first budget_data 'has_budget' is false.
                    aggregated_data['has_budget'] = true;
                }
            });
        }
        return aggregated_data;
    }

    function plot_budget_account_info(data){
        if(data === undefined || !(data)){
            data = get_budget_account_aggregated_data(current_budget_data);
        } else {
            // Get label on front to prevent caching i18n labels.
            data['label'] = get_group_label(data['level'], current_group);
        }
        current_budget_account_id = data['id'];

        var execution_group = 0;
        var execution_percentage = 0;
        var not_informed_text = "{% trans 'Execution not informed' %}";
        if(!data['has_budget']){
            not_informed_text = "{% trans 'No approved budget' %}";
        } else if(data['execution_aggregated']){
            var execution_percentage = data['execution_aggregated'] / data['budget_aggregated'];
            if(0 < execution_percentage && execution_percentage <= 0.2)
                execution_group = 1;
            else if(0.2 < execution_percentage && execution_percentage <= 0.4)
                execution_group = 2;
            else if(0.4 < execution_percentage && execution_percentage <= 0.6)
                execution_group = 3;
            else if(0.6 < execution_percentage && execution_percentage <= 0.8)
                execution_group = 4;
            else if(0.8 < execution_percentage)
                execution_group = 5;
        }
        data['not_informed_text'] = not_informed_text;
        data['execution_percentage'] = execution_percentage;
        data['execution_group'] = execution_group;
        data['budget_account_label'] = budget_account_label_map[current_budget_account];

        renderTemplate('#template-budget_account-info', data, '#budget_account-info');
    }

    function plot_breadcrumb(){
        renderTemplate('#template-breadcrumb', {data: breadcrumb}, '.breadcrumb-wrapper');
    }
    function init_breadcrumb(plot=false){
        breadcrumb = []
        breadcrumb.push({name: budget_account_label_map[current_budget_account], id: null});
        breadcrumb.push({name: "{% trans 'By' %} " + group_label_map[current_group], id: null});
        breadcrumb.push({name: get_budget_year_by_id(current_budget_id), id: null});
        if(plot){
            plot_breadcrumb();
        }
    }
    function update_breadcrumb(data=null){
        if(data){
            init_breadcrumb();
            if(data['level'] == 0){
                breadcrumb.push({name: data['name'], id: data['id']})
            } else {
                var parent_name = get_category_name_by_id(data['parent_id']);
                breadcrumb.push({name: parent_name, id: data['parent_id']});
                breadcrumb.push({name: data['name'], id: data['id']});
            }
        }
        plot_breadcrumb();
    }

    function plot_treemap(data){
        treemap = am4core.create("chart-treemap", am4charts.TreeMap);

        /* Define data fields */
        treemap.dataFields.value = "budget_aggregated";
        treemap.dataFields.name = "name";
        treemap.dataFields.children = "children";
        treemap.dataFields.color = "color";
        treemap.zoomOutButton.disabled = true;
        treemap.marginLeft = 0;
        treemap.marginRight = 0;
        treemap.maxLevels = 1;
        treemap.homeText = "Visualização por " + budget_account_label_map[current_budget_account];
        //treemap.layoutAlgorithm = treemap.slice;

        // Labels & tooltips
        var level_columns = []; var bullets = [];
        function config_label(level){
            var series_template = treemap.seriesTemplates.create(level);
            series_templates[level] = series_template;

            var columnTemplate = series_templates[level].columns.template;
            var hoverState = columnTemplate.states.create("hover");

            // Hover
            hoverState.adapter.add("fill", function (fill, target) {
                var data = target.sprite.dataItem.dataContext._dataContext;
                var hover_color = data.color_hover;
                if (fill instanceof am4core.Color) {
                    return am4core.color(hover_color);
                }
                return fill;
            })

            columnTemplate.events.on("hit", function(ev) {
                var data = ev.target.dataItem.dataContext._dataContext;  // data: api.BudgetAccountSerializer
                go_to_category(data['id']);
            }, this);

            // Label
            var bullet = series_templates[level].bullets.push(new am4charts.LabelBullet());
            bullet.label.fill = am4core.color("#ffffff");
            if(level == 2){
                bullet.locationX = 0.5;
                bullet.locationY = 0.5;
                bullet.label.adapter.add("html", function(html, target) {
                    var data = target.tooltipDataItem.dataContext.dataContext;
                    data['execution_percentage'] = data['execution_aggregated'] / data['budget_aggregated'];
                    return renderTemplate('#template-treemap-tooltip', data);
                });
                bullet.label.wrap = true;
            } else {
                bullet.interactionsEnabled = false;
                bullet.locationX = 0.02;
                bullet.label.textAlign = 'left';
                bullet.label.dx = 0;
                bullet.label.dy = -14;
                bullet.label.horizontalCenter = 'left';
                bullet.label.verticalCenter = 'middle';
                bullet.label.text = "{name}";
                bullet.label.fill = am4core.color("#ffffff");
            }

            // Tooltip
            columnTemplate.adapter.add('tooltipHTML', function(text, target) {
                var data = target.tooltipDataItem.dataContext.dataContext;
                data['execution_percentage'] = data['execution_aggregated'] / data['budget_aggregated'];
                return renderTemplate('#template-treemap-tooltip', data);
            });
            columnTemplate.tooltipY = am4core.percent(60);
            series_template.tooltip.getFillFromObject = false;
            series_template.tooltip.background.propertyFields.fill = "color_hover";
            series_template.tooltip.pointerOrientation = "vertical";
            series_template.tooltip.label.wrap = true;
            if(level == 2){
                series_template.tooltip.disabled = true;
            }
        }

        config_label(0);
        config_label(1);
        config_label(2);

        treemap.data = current_budget_data;
    }

    function plot_historical(data){
        var chart = am4core.create('historical-info', am4charts.XYChart);
        chart.zoomOutButton.disabled = true;
        chart.numberFormatter.bigNumberPrefixes = [
            {"number": 1e+3, "suffix": "K"},
            {"number": 1e+6, "suffix": "Mi"},
            {"number": 1e+9, "suffix": "Bi"},
            {"number": 1e+12, "suffix": "Tri"},
            {"number": 1e+15, "suffix": "Qua"}
            /*{"number": 1e+18, "suffix": "E"},
            {"number": 1e+21, "suffix": "Z"},
            {"number": 1e+24, "suffix": "Y"}*/
        ]

        chart.paddingTop = 50;
        chart.maskBullets = false;  // allow bullets to go out of plot area
        chart.colors.step = 2;
        chart.colors.list = [
            am4core.color("#0f69a3"),
            am4core.color("#98ccda"),
        ];

        // Legend
        chart.legend = new am4charts.Legend();
        chart.legend.position = 'right';
        chart.legend.valign = 'bottom';
        chart.legend.paddingLeft = 20;
        chart.legend.paddingBottom = 30;
        chart.legend.labels.template.maxWidth = 95;

        var xAxis = chart.xAxes.push(new am4charts.CategoryAxis())
        xAxis.dataFields.category = 'year'
        xAxis.renderer.cellStartLocation = 0.1
        xAxis.renderer.cellEndLocation = 0.9
        xAxis.renderer.grid.template.disabled = true;

        var yAxis = chart.yAxes.push(new am4charts.ValueAxis());
        yAxis.min = 0;
        yAxis.numberFormatter.numberFormat = "#. a";
        yAxis.renderer.grid.template.disabled = true;

        function createSeries(value, name) {
            var series = chart.series.push(new am4charts.ColumnSeries())
            series.dataFields.valueY = value
            series.dataFields.categoryX = 'year'
            series.name = name

            // Tooltip
            series.columns.template.tooltipText = "[{categoryX}: bold]{valueY.formatNumber('#,###')}[/]";

            // Label
            var bullet = series.bullets.push(new am4charts.LabelBullet());
            bullet.interactionsEnabled = false;
            bullet.dy = -20;
            bullet.fontSize = 12;
            bullet.label.verticalCenter = 'top';
            bullet.label.text = "{valueY.formatNumber('#.# a')}";
            bullet.label.fill = am4core.color('#0f2843');
            bullet.label.truncate = false;

            return series;
        }
        chart.data = data['data'];
        budget_account_label = get_current_budget_account_label();
        var title = budget_account_label + " {% trans 'of' %}<br>" + data['name'];
        $('.historical-title').html(title);
        createSeries('budget_aggregated', '{% trans "Budget" %}');
        createSeries('execution_aggregated', '{% trans "Execution" %}');
    }

    function plot_datatable(data, order_by, order_dir){
        data = data || current_budget_data;
        order_by = order_by || current_datatable_order['field'];
        order_dir = order_dir || current_datatable_order['order_dir'];
        data = sort_data(data, order_by, order_dir);
        var template_data = {
            'group_label': group_label_map[current_group],
            'sub_group_label': sub_group_label_map[current_group],
            'budget_accounts': data,
            'order_by': current_datatable_order['field'],
            'order_dir': current_datatable_order['order_dir']
        }
        renderTemplate('#template-budget_account-table', template_data, '#datatable-info');
        if(current_budget_account_id){
            select_datatable_row(current_budget_account_id);
        }
    }

    function sort_data(data, order_by, order_dir){
        data.forEach(function(elem){
            elem['children'] = sortByKey(elem['children'], order_by, order_dir);
            if(order_by == 'budget_aggregated'){
                elem['children'] = sortByKey(elem['children'], 'has_budget', 'desc');
            }
        });
        data = sortByKey(data, order_by, order_dir);
        if(order_by == 'budget_aggregated'){
            data = sortByKey(data, 'has_budget', 'desc');
        }
        current_datatable_order['field'] = order_by;
        current_datatable_order['order_dir'] = order_dir;
        return data;
    }

    function init_views(budget_data){
        current_budget_account_id = null;

        init_breadcrumb(true);
        plot_treemap(budget_data);
        plot_budget_account_info();
        loading(false, '.treemap-wrapper');
        plot_datatable(budget_data);
        loading(false, '.datatable-wrapper');
        get_historical_and_plot_view();
        loading(false, '.historical-wrapper');
    }
    function get_budget_and_plot_views(budget_id, budget_account, group){
        loading(true);

        get_budget_basic_info(budget_id, function (data) {
            $('.budget-currency').html(data['currency_display']);
            $('.download-link').attr('href', data['output_file']);
        });
        current_budget_account = budget_account;
        current_budget_id = budget_id;
        current_group = group;

        $('.budget-account-selector a').removeClass('active');
        $('.budget-account-selector a[data-budget_account="'+budget_account+'"]').addClass('active');
        $('.group-selector a').hide();
        $('.group-selector .'+ budget_account +'-group').show();
        $('.budget-selector a').removeClass('active');
        $('.budget-selector a[data-budget_id="'+budget_id+'"]').addClass('active');
        $('.group-selector a').removeClass('active');
        $('.group-selector a[data-group="'+group+'"]').addClass('active');
        update_search_placeholders();

        get_budget_data(budget_id, budget_account, group, function(data){
            current_budget_data = data;
            init_views(current_budget_data);
            inactive_budget_accounts_without_data();
        });
    }
    function update_search_placeholders(){
        var msg = "{% trans 'Search for' %} " + budget_account_label_map[current_budget_account].toLowerCase();
        $('#search').attr('placeholder', msg);
        $('.search-link').attr('title', msg);
    }
    function inactive_budget_accounts_without_data(){
        // Inactive budget_accounts and groups without data and toggle closest with data.
        $('.group-selector a').removeClass('inactive').attr('title', "");
        $('.budget-account-selector a').removeClass('inactive').attr('title', "");
        var budget_data = budgets[current_budget_id];
        var budget_account_map = {
            'expenses': {
                msg: "{% trans 'Expenses data not available for this year' %}",
                sibling: 'revenues',
                groups: {
                    'functional': {
                        msg: "{% trans 'Functional data not available' %}",
                        sibling: 'organic'
                    },
                    'organic': {
                        msg: "{% trans 'Organic data not available' %}",
                        sibling: 'functional'
                    }
                }
            },
            'revenues': {
                msg: "{% trans 'Revenues data not available for this year' %}",
                sibling: 'expenses',
                groups: {
                    'nature': {
                        msg: "{% trans 'Data by nature not available' %}",
                        sibling: 'source'
                    },
                    'source': {
                        msg: "{% trans 'Data by source not available' %}",
                        sibling: 'nature'
                    }
                }
            }
        }
        Object.entries(budget_account_map).forEach(([budget_account, ba_values]) => {
            if(!budget_data['available_budget_accounts'].includes(budget_account)){
                $('.budget-account-selector [data-budget_account="'+budget_account+'"]').addClass('inactive').attr('title', ba_values['msg']);
                if(current_budget_account == budget_account){
                    toggle_budget_account(ba_values.sibling);
                    return;
                }
            }
            Object.entries(ba_values.groups).forEach(([group, group_values]) => {
                if(!budget_data['available_groups'].includes(group)){
                    $('.group-selector [data-group="'+group+'"]').addClass('inactive').attr('title', group_values['msg']);
                    if(current_group == group){
                        toggle_group(group_values.sibling);
                        return;
                    }
                }
            });
        });
    }
    function get_historical_and_plot_view(){
        get_historical_data(current_budget_id, current_budget_account, current_budget_account_id, current_group, function(data){
            plot_historical(data);
        });
    }
    function get_budget_account_default_group(budget_account){
        var map = {
            'expenses': 'functional',
            'revenues': 'nature'
        }
        return map[budget_account]
    }
    function toggle_budget_account(budget_account){
        var group = get_budget_account_default_group(budget_account)
        get_budget_and_plot_views(current_budget_id, budget_account, group);
    }
    function toggle_budget(budget_id){
        get_budget_and_plot_views(budget_id, current_budget_account, current_group);
    }
    function toggle_group(group){
        get_budget_and_plot_views(current_budget_id, current_budget_account, group);
    }
    function get_budget_year_by_id(budget_id){
        return $('.budget-selector a[data-budget_id="'+budget_id+'"]').html();
    }
    function get_current_budget_account_label(){
        return budget_account_label_map[current_budget_account]
    }

    function toggle_datatable_row(category_id){
        $base_selector = $('.datatable-info');
        var $tr = $base_selector.find('[data-category_id="'+category_id+'"]');
        $tr.find('.arrow:not(".no-children")').toggle();
        $base_selector.find('.subcategory-of-' + category_id).toggle();
    }
    function expand_datatable(){
        $base_selector = $('.datatable-info');
        $base_selector.find('.child-category').show();
        $base_selector.find('.arrow:not(".no-children")').hide();
        $base_selector.find('.arrow-expanded').show();
    }
    function collapse_datatable(){
        $base_selector = $('.datatable-info');
        $base_selector.find('.child-category').hide();
        $base_selector.find('.arrow:not(".no-children")').hide();
        $base_selector.find('.arrow-collapsed').show();
    }

    function select_datatable_row(category_id){
        $base_selector = $('.datatable-info');

        // Reset datatable to original state.
        $base_selector.find('.arrow-expanded').hide();
        $base_selector.find('.arrow-collapsed').show();
        $base_selector.find('.child-category').hide();
        $base_selector.find('tr').removeClass('highlight');

        var $tr = $base_selector.find('[data-category_id="'+category_id+'"]');
        var parent_id = category_id;
        if($tr.data('parent_id')){
            parent_id = $tr.data('parent_id');
        }
        var $children = $base_selector.find('.subcategory-of-' + parent_id);
        var $parent = $base_selector.find('[data-category_id="'+parent_id+'"]');

        $parent.find('.arrow:not(".no-children")').toggle();
        $parent.addClass('highlight');
        $tr.addClass('highlight');
        $children.show();
    }

    function go_to_category(category_id){
        current_budget_account_id = category_id;
        var data = null;

        // Get data from treemap.
        treemap.dataItems.each(function(dataItem){
            if(dataItem.dataContext.id == category_id){
                data = dataItem.dataContext;
                treemap.zoomToChartDataItem(dataItem);
                return;
            }
            dataItem.children.each(function(dataItemChildren){
                if(dataItemChildren.dataContext.id == category_id){
                    data = dataItemChildren.dataContext;
                    treemap.zoomToChartDataItem(dataItemChildren);
                    return;
                }
            });
        });
        if(!data)
            return;

        plot_budget_account_info(data);
        get_historical_and_plot_view();
        update_breadcrumb(data);
        select_datatable_row(category_id);
    }

    function get_category_name_by_id(category_id){
        $td = $('.datatable-info tr[data-category_id="'+category_id+'"]').find('.category-name');
        return $td.html();
    }

    function search_term(term){
        var $base_selector = $('.datatable-info tbody');
        $('body').removeHighlight();
        $base_selector.find('.search-match').removeClass('search-match');
        if (term) {
            $base_selector.highlight(term);
            $('span.' + highlight_class).closest('tr').each(function(idx){
                $(this).addClass('search-match');
                if($(this).hasClass('child-category')){
                    var parent_id = $(this).data('parent_id');
                    $base_selector.find('tr[data-category_id="'+parent_id+'"]').addClass('search-match');
                }
            });
            expand_datatable();
            $base_selector.find('tr:not(".search-match")').hide();
            $base_selector.find('tr.search-match').show();
        } else {
            collapse_datatable();
            plot_datatable();
        }
    }

    function start_tutorial(){
        introJs().setOptions({
            nextLabel: 'Próximo',
            prevLabel: 'Anterior',
            doneLabel: 'Pronto',
            hidePrev: true,
            tooltipClass: 'customIntro',
            showProgress: true,
            showBullets: false,
            steps: [
            {% for t in tutorial %}
            {
                'element': document.querySelector('{{ t.element }}'),
                'title': '{{ t.title }}',
                'intro': '{{ t.text|safe }}'
                {% if t.position %}
                    ,'position': '{{ t.position }}'
                {% endif %}
                {% if t.scrollTo %}
                    ,'scrollTo': '{{ t.scrollTo }}'
                {% endif %}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
            ]
        }).start();
    }

    $(document).ready(function () {
        // Binds
        $('.budget-account-selector-row a').on('click', function (ev) {
            ev.preventDefault();
        });
        $(document).on('click', '.budget-account-selector a:not(".inactive")', function (ev) {
            ev.preventDefault();
            var budget_account = $(this).data('budget_account');
            toggle_budget_account(budget_account);
        });
        $(document).on('click', '.group-selector a:not(".inactive")', function (ev) {
            ev.preventDefault();
            var group = $(this).data('group');
            toggle_group(group);
        });
        $(document).on('click', '.budget-selector a:not(".inactive")', function (ev) {
            ev.preventDefault();
            var budget_id = $(this).data('budget_id');
            toggle_budget(budget_id);
        });

        $(document).on('click', '.breadcrumb-link', function(ev){
            ev.preventDefault();
            var breadcrumb_index = parseInt($(this).data('breadcrumb_idx'));
            if(breadcrumb_index <= 2){
                init_views(current_budget_data);
            } else {
                go_to_category(breadcrumb[breadcrumb_index].id);
                //breadcrumb[breadcrumb_index].event.target.dispatchImmediately('hit');
            }
        });
        $(document).on('click', '.datatable-info .expand-visualization', function(ev){
            var category_id = $(this).closest('tr').data('category_id');
            go_to_category(category_id);
        });
        $(document).on('click', '.datatable-info tr.parent-category .category-toggle', function(ev){
            var category_id = $(this).closest('tr').data('category_id');
            toggle_datatable_row(category_id, false);
        });
        $(document).on('click', '.visualization-selector a, .search-selector a', function(ev){
            var selector = $(this).attr('href');
            $('html, body').animate({
                scrollTop: $(selector).offset().top
            }, 1000);
        });
        $(document).on('click', '.tutorial', function(ev){
            ev.preventDefault();
            start_tutorial();
        });
        $(document).on('click', '.datatable-info th', function(ev){
            // Sort datatable
            var field = $(this).data('field');
            if(field === undefined){
                return;
            }
            if(field == current_datatable_order['field']) {
                // Toggle order_dir if is the same field.
                var order_dir = current_datatable_order['order_dir'] == 'asc' ? 'desc' : 'asc';
            }
            plot_datatable(current_budget_data, field, order_dir);
            $('#search').trigger('change');
        });
        $('#search').on('keyup change', function (ev) {
            var term = $(this).val();
            search_term(term);
        });
        $(document).on('click', '.search-link', function(ev){
            $('#search').focus();
        });

        // Init
        toggle_budget_account(current_budget_account)
    });

    </script>
{% endblock %}

{% block content %}
<div class="page-country-detail">
    {% with bg_name="bg_"|add:country.slug|add:".png" %}
    <div class="country-name-wrapper" style="background-image: url('{% static 'img/'|add:bg_name %}');">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h1>{{ country.name }}</h1>
                </div>
            </div>
        </div>
    </div>
    {% endwith %}
    <div class="flag-wrapper">
        <div class="row middle">
            <div class="col-2 mr-0">
                <img class="flag" src="{{ country.flag.url }}" alt="{{ country.slug }} flag" />
            </div>
            <div class="col-5">
                <h3>
                    <span class="arrow-right"></span>
                    {% trans "BUDGET DATA" %}
                </h3>
                <div class="header-currency">
                    {% trans "All values in" %} <strong class="budget-currency">{{ last_budget.get_currency_display }}</strong>
                </div>
            </div>
            <div class="col-4 right">
                <a href="#" class="tutorial">{% trans "HOW TO NAVIGATE" %}</a>
            </div>
        </div>
    </div>

    {% include 'frontend/budget-selector.component.html' with visualization='treemap' hide_currency=True %}
    <div class="treemap-wrapper viz-wrapper">
        <div class="loading">{% trans "Loading data" %}<br><img src="{% static 'img/loading-front.gif' %}" /></div>
        <div class="row">
            <div class="col-3 budget_account-info-wrapper">
                <div id="budget_account-info"></div>
            </div>
            <div class="col-9 chart-wrapper">
                <div id="chart-treemap"></div>
            </div>
        </div>
    </div>

    {% include 'frontend/budget-selector.component.html' with visualization='history' %}
    <div class="historical-wrapper viz-wrapper">
        <div class="loading">{% trans "Loading data" %}<br><img src="{% static 'img/loading-front.gif' %}" /></div>
        <h4 class="historical-title"></h4>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div id="historical-info"></div>
                </div>
            </div>
        </div>
    </div>

    {% include 'frontend/budget-selector.component.html' with visualization='list' show_export=True %}
    <div class="datatable-wrapper viz-wrapper">
        <div class="loading">{% trans "Loading data" %}<br><img src="{% static 'img/loading-front.gif' %}" /></div>
        <div class="row">
            <div class="col-12">
                <div class="datatable-search-wrapper">
                    <span class="material-icons">search</span>
                    <input type="text" id="search" class="search-data" placeholder="Busque por Órgão ou Unidade Orçamentária"/>
                </div>
                <div id="datatable-info"></div>
            </div>
        </div>
    </div>

    {% include 'frontend/transparency-text.component.html' %}

</div>

{% verbatim %}
<script id="template-budget_account-info" type="text/x-handlebars-template">
<div class="budget_account-info">
    <div class="budget_account-info-box">
        <div class="label-wrapper">{{ label }}</div>
        <div class="name-wrapper">{{ name }}</div>
        <div class="aggregated-data">
            <table class="primary-info" cellspacing="0" cellpadding="0">
                <tr>
                    <td>{% endverbatim %}{% trans "Initial budget" %}{% verbatim %}</td>
                    <td class="money-display">
                        {{#if has_budget}}
                            {{formatCurrency initial_budget_aggregated}}
                        {{else}}
                            {% endverbatim %}{% trans "Not informed" %}{% verbatim %}
                        {{/if}}
                    </td>
                </tr>
                <tr>
                    <td>{% endverbatim %}{% trans "Updated budget" %}{% verbatim %}</td>
                    <td class="money-display">
                        {{#if has_budget}}
                            {{formatCurrency budget_aggregated}}
                        {{else}}
                            {% endverbatim %}{% trans "Not informed" %}{% verbatim %}
                        {{/if}}
                    </td>
                </tr>
                <tr class="execution-aggregated">
                    <td>{% endverbatim %}{% trans "Execution" %}{% verbatim %}</td>
                    <td class="money-display">
                        {{#if execution_aggregated}}
                            {{formatCurrency execution_aggregated}}
                        {{else}}
                            {% endverbatim %}{% trans "Not informed" %}{% verbatim %}
                        {{/if}}
                    </td>
                </tr>
            </table>
        </div>
        <div>
            <table class="treemap-legend-table execution-group-{{ execution_group }}">
                <tr class="legend-square">
                    <td class="group-0"><div class="treemap-legend">&nbsp;</div></td>
                    <td class="group-1"><div class="treemap-legend">&nbsp;</div></td>
                    <td class="group-2"><div class="treemap-legend">&nbsp;</div></td>
                    <td class="group-3"><div class="treemap-legend">&nbsp;</div></td>
                    <td class="group-4"><div class="treemap-legend">&nbsp;</div></td>
                    <td class="group-5"><div class="treemap-legend">&nbsp;</div></td>
                </tr>
                <tr>
                    <td class="group-0">N/A</td>
                    <td class="group-1">0-20%</td>
                    <td class="group-2">20-40%</td>
                    <td class="group-3">40-60%</td>
                    <td class="group-4">60-80%</td>
                    <td class="group-5">+ de 80%</td>
                </tr>
                <tr>
                    <td class="group-0"><div class="execution-group-indicator"></div></td>
                    <td class="group-1"><div class="execution-group-indicator"></div></td>
                    <td class="group-2"><div class="execution-group-indicator"></div></td>
                    <td class="group-3"><div class="execution-group-indicator"></div></td>
                    <td class="group-4"><div class="execution-group-indicator"></div></td>
                    <td class="group-5"><div class="execution-group-indicator"></div></td>
                </tr>
                <tr>
                    <td class="group-0"><div class="execution-percentage">{{ not_informed_text }}</div></td>
                    <td class="group-1"><div class="execution-percentage"><strong>{{formatPercent execution_percentage}}</strong><br>{% endverbatim %}{% trans 'executed' %}{% verbatim %}</div></td>
                    <td class="group-2"><div class="execution-percentage"><strong>{{formatPercent execution_percentage}}</strong><br>{% endverbatim %}{% trans 'executed' %}{% verbatim %}</div></td>
                    <td class="group-3"><div class="execution-percentage"><strong>{{formatPercent execution_percentage}}</strong><br>{% endverbatim %}{% trans 'executed' %}{% verbatim %}</div></td>
                    <td class="group-4"><div class="execution-percentage"><strong>{{formatPercent execution_percentage}}</strong><br>{% endverbatim %}{% trans 'executed' %}{% verbatim %}</div></td>
                    <td class="group-5"><div class="execution-percentage"><strong>{{formatPercent execution_percentage}}</strong><br>{% endverbatim %}{% trans 'executed' %}{% verbatim %}</div></td>
                </tr>
            </table>
        </div>
    </div>
    <hr class="mt-0">
    <div class="budget_account-info-box secondary-info-wrapper">
        <div>
            {% endverbatim %}{% trans "SECONDARY DATA" %}{% verbatim %} <span class="arrow-down"></span>
        </div>
    </div>
    <div class="budget_account-info-box">
        <table class="secondary-info">
            <tr>
                <td colspan="2" class="info-title">
                    {{ budget_account_label }} {% endverbatim %}{% trans "in Investment" %}{% verbatim %}
                </td>
            </tr>
            <tr>
                <td>{% endverbatim %}{% trans "Budget" %}{% verbatim %}</td>
                <td class="money-display">{{formatCurrency budget_investment}}</td>
            </tr>
            <tr>
                <td>{% endverbatim %}{% trans "Execution" %}{% verbatim %}</td>
                <td class="money-display">{{formatCurrency execution_investment}}</td>
            </tr>
            <tr>
                <td colspan="2" class="info-title">{{ budget_account_label }} {% endverbatim %}{% trans "in Operation" %}{% verbatim %}</td>
            </tr>
            <tr>
                <td>{% endverbatim %}{% trans "Budget" %}{% verbatim %}</td>
                <td class="money-display">{{formatCurrency budget_operation}}</td>
            </tr>
            <tr>
                <td>{% endverbatim %}{% trans "Execution" %}{% verbatim %}</td>
                <td class="money-display">{{formatCurrency execution_operation}}</td>
            </tr>
        </table>
    </div>
</div>
</script>
{% endverbatim %}

{% verbatim %}
<script id="template-budget_account-table" type="text/x-handlebars-template">
<table class="datatable-info" cellpadding="0" cellspacing="0">
    <thead>
        <tr>
            <th data-field="name">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by name' %}{% verbatim %}">
                    <div class="field-name">{{ group_label }} / {{ sub_group_label }}</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'name') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'name') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th class="vertical-separator"></th>
            <th data-field="budget_aggregated">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by budget' %}{% verbatim %}">
                    <div class="field-name">{% endverbatim %}{% trans "Budget" %}{% verbatim %}</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'budget_aggregated') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'budget_aggregated') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th data-field="execution_aggregated">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by execution' %}{% verbatim %}">
                    <div class="field-name">{% endverbatim %}{% trans "Execution" %}{% verbatim %}</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'execution_aggregated') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'execution_aggregated') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th data-field="execution_percentage">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by execution percentage' %}{% verbatim %}">
                    <div class="field-name">%</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'execution_percentage') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'execution_percentage') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th data-field="budget_investment">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by budget in investment' %}{% verbatim %}">
                    <div class="field-name">{% endverbatim %}{% trans "Budget in investment" %}{% verbatim %}</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'budget_investment') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'budget_investment') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th data-field="execution_investment">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by execution in investment' %}{% verbatim %}">
                    <div class="field-name">{% endverbatim %}{% trans "Execution in investment" %}{% verbatim %}</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'execution_investment') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'execution_investment') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th data-field="budget_operation">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by budget in operation' %}{% verbatim %}">
                    <div class="field-name">{% endverbatim %}{% trans "Budget in operation" %}{% verbatim %}</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'budget_operation') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'budget_operation') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th data-field="execution_operation">
                <div class="header-container" title="{% endverbatim %}{% trans 'Sort by execution in operation' %}{% verbatim %}">
                    <div class="field-name">{% endverbatim %}{% trans "Execution in operation" %}{% verbatim %}</div>
                    <div class="order-arrows">
                        <span class="arrow-up {{#if (and (eq order_by 'execution_operation') (eq order_dir 'asc'))}}active{{/if}}"></span>
                        <span class="arrow-down {{#if (and (eq order_by 'execution_operation') (eq order_dir 'desc'))}}active{{/if}}"></span>
                    </div>
                </div>
            </th>
            <th></th>
        </tr>
        <tr>
            <td class="separator" colspan="10"></td>
        </tr>
    </thead>
    <tbody>
        {{#each budget_accounts}}
        <tr data-category_id="{{ id }}" class="parent-category">
            <td class="category-toggle">
                {{#if children}}
                <span class="material-icons arrow arrow-collapsed">keyboard_arrow_right</span>
                <span class="material-icons arrow arrow-expanded" style="display: none;">keyboard_arrow_down</span>
                {{ else }}
                <span class="material-icons arrow no-children">fiber_manual_record</span>
                {{/if}}
                <span class="category-name">{{ name }}</span>
            </td>
            <td class="vertical-separator"></td>
            <td>
                {{#if has_budget}}
                {{formatCurrency budget_aggregated}}
                {{else}}
                -
                {{/if}}
            </td>
            <td>{{formatCurrency execution_aggregated}}</td>
            <td>{{formatPercent execution_percentage}}</td>
            <td>{{formatCurrency budget_investment}}</td>
            <td>{{formatCurrency execution_investment}}</td>
            <td>{{formatCurrency budget_operation}}</td>
            <td>{{formatCurrency execution_operation}}</td>
            <td><span class="expand-visualization material-icons" title="Expandir para todas visualizações">open_in_full</span></td>
        </tr>
            {{#each children}}
            <tr class="child-category subcategory-of-{{ parent_id }}" data-parent_id="{{ parent_id }}" data-category_id="{{ id }}" style="display: none;">
                <td style="padding-left: 40px;">
                    <span class="category-name">{{ name }}</span>
                </td>
                <td class="vertical-separator"></td>
                <td>
                    {{#if has_budget}}
                    {{formatCurrency budget_aggregated}}
                    {{else}}
                    -
                    {{/if}}
                </td>
                <td>{{formatCurrency execution_aggregated}}</td>
                <td>{{formatPercent execution_percentage}}</td>
                <td>{{formatCurrency budget_investment}}</td>
                <td>{{formatCurrency execution_investment}}</td>
                <td>{{formatCurrency budget_operation}}</td>
                <td>{{formatCurrency execution_operation}}</td>
                <td><span class="expand-visualization material-icons" title="{% endverbatim %}{% trans 'Expand to all visualizations' %}{% verbatim %}">open_in_full</span></td>
            </tr>
            {{/each}}
        {{/each}}
    </tbody>
</table>
</script>

<script id="template-breadcrumb" type="text/x-handlebars-template">
{{#each data}}
    <a href="#" class="breadcrumb-link" data-breadcrumb_idx="{{@index}}">{{{ name }}}</a>
    <span class="arrow-right"></span>
{{/each}}
</script>
{% endverbatim %}

{% verbatim %}
<script id="template-treemap-tooltip" type="text/x-handlebars-template">
<div class="treemap-tooltip">
    <h5>{{ name }}</h5>
    <table>
        <tr>
            <td>{% endverbatim %}{% trans 'Budget' %}{% verbatim %}</td>
            <td class="money-display">
                {{#if has_budget}}
                    {{formatCurrency budget_aggregated}}
                {{else}}
                    {% endverbatim %}{% trans 'Not informed' %}{% verbatim %}
                {{/if}}
            </td>
            <td></td>
        </tr>
        {{#if budget_investment}}
        <tr class="secondary-info">
            <td>{% endverbatim %}{% trans 'in Investment' %}{% verbatim %}</td>
            <td class="money-display">{{formatCurrency budget_investment}}</td>
            <td></td>
        </tr>
        {{/if}}
        {{#if budget_operation}}
        <tr class="secondary-info">
            <td>{% endverbatim %}{% trans 'in Operation' %}{% verbatim %}</td>
            <td class="money-display">{{formatCurrency budget_operation}}</td>
            <td></td>
        </tr>
        {{/if}}
        <tr>
            <td>{% endverbatim %}{% trans 'Execution' %}{% verbatim %}</td>
            {{#if execution_aggregated}}
            <td class="money-display">{{formatCurrency execution_aggregated}}</td>
            <td><span class="execution_percent">({{formatPercent execution_percentage}})</span></td>
            {{else}}
            <td class="no-value">{% endverbatim %}{% trans 'Not informed' %}{% verbatim %}</td>
            <td></td>
            {{/if}}
        </tr>
        {{#if execution_investment}}
        <tr class="secondary-info">
            <td>{% endverbatim %}{% trans 'in Investment' %}{% verbatim %}</td>
            <td class="money-display">{{formatCurrency execution_investment}}</td>
            <td></td>
        </tr>
        {{/if}}
        {{#if execution_operation}}
        <tr class="secondary-info">
            <td>{% endverbatim %}{% trans 'in Operation' %}{% verbatim %}</td>
            <td class="money-display">{{formatCurrency execution_operation}}</td>
            <td></td>
        </tr>
        {{/if}}
    </table>
</div>
</script>
{% endverbatim %}

{% endblock %}